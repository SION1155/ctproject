<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í•œì ì—ì–´ í˜ì¸íŒ… í•™ìŠµ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <style>
        .canvas-container {
            position: relative;
            border: 4px solid #3b82f6;
            border-radius: 16px;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }
        .drawing-trail {
            position: absolute;
            width: 12px;
            height: 12px;
            background: radial-gradient(circle, #3b82f6 0%, #1d4ed8 100%);
            border-radius: 50%;
            pointer-events: none;
            animation: trailFade 1.5s ease-out forwards;
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.6);
        }
        @keyframes trailFade {
            0% { opacity: 1; transform: scale(1); }
            100% { opacity: 0; transform: scale(0.3); }
        }
        .gesture-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            z-index: 10;
        }
        .writing-area {
            background: rgba(0, 0, 0, 0.3);
            border: 2px dashed #ffffff;
            border-radius: 12px;
        }
        .popup-button {
            position: absolute;
            bottom: 20px;
            background: rgba(255, 255, 255, 0.95);
            border: 3px solid #e2e8f0;
            border-radius: 16px;
            padding: 16px 32px;
            font-weight: 700;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 20px -2px rgba(0, 0, 0, 0.15);
            z-index: 20;
        }
        .popup-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 25px -5px rgba(0, 0, 0, 0.2);
        }
        .popup-button.active {
            transform: scale(1.1);
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.3);
        }
        .clear-btn {
            left: 50px;
            background: #ef4444;
            color: white;
            border-color: #dc2626;
        }
        .complete-btn {
            right: 50px;
            background: #10b981;
            color: white;
            border-color: #059669;
        }
        .finger-point {
            position: absolute;
            width: 24px;
            height: 24px;
            background: #f59e0b;
            border: 4px solid #ffffff;
            border-radius: 50%;
            pointer-events: none;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 20px rgba(245, 158, 11, 0.8);
            animation: fingerPulse 1s infinite;
            z-index: 15;
        }
        .finger-point.drawing {
            background: #3b82f6;
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.8);
        }
        .finger-point.clicking {
            background: #ef4444;
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.8);
            animation: clickPulse 0.3s ease-out;
        }
        @keyframes fingerPulse {
            0%, 100% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.2); }
        }
        @keyframes clickPulse {
            0% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.5); }
            100% { transform: translate(-50%, -50%) scale(1); }
        }
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .popup-content {
            background: white;
            border-radius: 24px;
            padding: 24px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            max-width: 95vw;
            max-height: 95vh;
        }
        
        /* ìŠ¬ë¼ì´ë“œ íˆ´ë°” */
        .slide-toolbar {
            position: absolute;
            right: -200px;
            top: 50%;
            transform: translateY(-50%);
            width: 200px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px 0 0 20px;
            padding: 20px;
            box-shadow: -5px 0 20px rgba(0, 0, 0, 0.2);
            transition: right 0.3s ease;
            z-index: 25;
        }
        .slide-toolbar.active {
            right: 0;
        }
        .slide-trigger {
            position: absolute;
            right: 0;
            top: 0;
            width: 50px;
            height: 100%;
            z-index: 30;
        }
        .tool-section {
            margin-bottom: 20px;
        }
        .tool-title {
            font-size: 14px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 10px;
        }
        .pen-size-option {
            width: 40px;
            height: 40px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            margin: 5px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .pen-size-option.active {
            border-color: #3b82f6;
            background: #eff6ff;
        }
        .pen-size-preview {
            background: #374151;
            border-radius: 50%;
        }
        .color-option {
            width: 40px;
            height: 40px;
            border: 2px solid #e5e7eb;
            border-radius: 50%;
            margin: 5px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        .color-option.active {
            border-color: #374151;
            transform: scale(1.1);
        }
        .color-option::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: inherit;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 min-h-screen">
    <!-- í•™ìƒ ì •ë³´ ì…ë ¥ í™”ë©´ -->
    <div id="studentInfoScreen" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl shadow-2xl p-10 w-full max-w-lg">
            <div class="text-center mb-10">
                <div class="text-6xl mb-4">âœ‹</div>
                <h1 class="text-4xl font-bold text-gray-800 mb-3">í•œì ì—ì–´ í˜ì¸íŒ…</h1>
                <p class="text-gray-600 text-lg">ì†ê°€ë½ìœ¼ë¡œ í—ˆê³µì— í•œìë¥¼ ì¨ë³´ì„¸ìš”</p>
            </div>
            <form id="studentForm" class="space-y-6">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-3">ì´ë¦„</label>
                    <input type="text" id="studentName" required 
                           class="w-full px-5 py-4 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent text-lg">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-3">í•™ë…„</label>
                        <select id="studentGrade" required class="w-full px-5 py-4 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 text-lg">
                            <option value="">ì„ íƒ</option>
                            <option value="1">1í•™ë…„</option>
                            <option value="2">2í•™ë…„</option>
                            <option value="3">3í•™ë…„</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-3">ë°˜</label>
                        <input type="number" id="studentClass" min="1" max="20" required 
                               class="w-full px-5 py-4 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 text-lg">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-3">ë²ˆí˜¸</label>
                    <input type="number" id="studentNumber" min="1" max="40" required 
                           class="w-full px-5 py-4 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 text-lg">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-3">ì´ë©”ì¼</label>
                    <input type="email" id="studentEmail" required 
                           class="w-full px-5 py-4 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 text-lg">
                </div>
                <button type="submit" 
                        class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white font-bold py-4 px-6 rounded-xl transition duration-300 transform hover:scale-105 text-lg shadow-lg">
                    ğŸš€ í•œìì“°ê¸°í…ŒìŠ¤íŠ¸ ì‹œì‘
                </button>
            </form>
        </div>
    </div>

    <!-- ë©”ì¸ í•™ìŠµ í™”ë©´ -->
    <div id="learningScreen" class="hidden min-h-screen">
        <!-- í—¤ë” -->
        <div class="bg-white shadow-xl border-b-4 border-blue-200 p-6">
            <div class="max-w-7xl mx-auto flex justify-between items-center">
                <div class="flex items-center space-x-6">
                    <h1 class="text-3xl font-bold text-gray-800">âœ‹ í•œì ì—ì–´ í˜ì¸íŒ…</h1>
                    <div class="text-lg text-gray-600">
                        <span id="studentInfo"></span>
                    </div>
                </div>
                <div class="flex items-center space-x-6">
                    <div class="text-2xl font-bold text-blue-600 bg-blue-50 px-4 py-2 rounded-lg">
                        ì ìˆ˜: <span id="currentScore">0</span>/250
                    </div>
                    <div class="text-lg text-gray-600 bg-gray-50 px-4 py-2 rounded-lg">
                        ë¬¸ì œ: <span id="currentQuestion">1</span>/25
                    </div>
                </div>
            </div>
        </div>

        <!-- ë©”ì¸ ì»¨í…ì¸  -->
        <div class="max-w-7xl mx-auto p-6">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- ë¬¸ì œ ì •ë³´ íŒ¨ë„ -->
                <div class="bg-white rounded-3xl shadow-xl p-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                        ğŸ“š ë¬¸ì œ ì •ë³´
                    </h2>
                    <div class="space-y-6">
                        <div class="p-6 bg-gradient-to-br from-blue-50 to-blue-100 rounded-2xl">
                            <label class="block text-sm font-semibold text-gray-700 mb-3">ëœ»</label>
                            <div id="characterMeaning" class="text-3xl font-bold text-blue-600"></div>
                        </div>
                        <div class="p-6 bg-gradient-to-br from-green-50 to-green-100 rounded-2xl">
                            <label class="block text-sm font-semibold text-gray-700 mb-3">ìŒ</label>
                            <div id="characterSound" class="text-3xl font-bold text-green-600"></div>
                        </div>
                        <div class="p-6 bg-gradient-to-br from-gray-50 to-gray-100 rounded-2xl">
                            <label class="block text-sm font-semibold text-gray-700 mb-3">ì •ë‹µ í•œì</label>
                            <div class="bg-white p-4 rounded-xl border-2 border-gray-200">
                                <img id="answerImage" src="" alt="ì •ë‹µ í•œì" class="w-32 h-32 mx-auto object-contain">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ê·¸ë¦¬ê¸° ì‹œì‘ ë²„íŠ¼ ì˜ì—­ -->
                <div class="lg:col-span-2 bg-white rounded-3xl shadow-xl p-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                        âœ‹ í•œì ì“°ê¸°
                    </h2>
                    <div class="text-center">
                        <div class="bg-gradient-to-br from-blue-50 to-indigo-100 rounded-2xl p-12 mb-6">
                            <div class="text-8xl mb-6">ğŸ¨</div>
                            <h3 class="text-2xl font-bold text-gray-800 mb-4">í—ˆê³µì— í•œìë¥¼ ì¨ë³´ì„¸ìš”</h3>
                            <p class="text-gray-600 mb-8">íŒì—… ì°½ì—ì„œ ì†ê°€ë½ìœ¼ë¡œ í•œìë¥¼ ê·¸ë ¤ì£¼ì„¸ìš”</p>
                        </div>
                        <button id="openDrawingBtn" 
                                class="bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white font-bold py-4 px-8 rounded-xl transition duration-300 transform hover:scale-105 text-xl shadow-lg">
                            ğŸ–Œï¸ ê·¸ë¦¬ê¸° ì‹œì‘
                        </button>
                    </div>
                </div>
            </div>

            <!-- ê²°ê³¼ ë° ì œì–´ íŒ¨ë„ -->
            <div class="mt-6 bg-white rounded-3xl shadow-xl p-8">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                            ğŸ“Š ê²°ê³¼
                        </h2>
                        <div id="resultPanel" class="space-y-4">
                            <div class="text-center text-gray-500 p-8 bg-gray-50 rounded-2xl">
                                í—ˆê³µì— í•œìë¥¼ ì¨ì£¼ì„¸ìš”
                            </div>
                        </div>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                            ğŸ® ì œì–´
                        </h2>
                        <div class="space-y-4">
                            <button id="nextBtn" disabled class="w-full bg-gradient-to-r from-blue-500 to-indigo-500 hover:from-blue-600 hover:to-indigo-600 disabled:from-gray-300 disabled:to-gray-300 text-white py-4 px-6 rounded-xl transition font-semibold text-lg">
                                â¡ï¸ ë‹¤ìŒ ë¬¸ì œ
                            </button>
                            <button id="endLearningBtn" class="w-full bg-gradient-to-r from-red-500 to-pink-500 hover:from-red-600 hover:to-pink-600 text-white py-4 px-6 rounded-xl transition font-semibold text-lg">
                                ğŸ í•™ìŠµ ì¢…ë£Œ
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ê·¸ë¦¬ê¸° íŒì—… -->
    <div id="drawingPopup" class="hidden popup-overlay">
        <div class="popup-content">
            <div class="canvas-container">
                <video id="videoElement" width="800" height="600" autoplay muted class="rounded-2xl opacity-60" style="transform: scaleX(-1);"></video>
                <canvas id="drawingCanvas" width="800" height="600" class="absolute top-0 left-0 rounded-2xl writing-area"></canvas>
                <div id="gestureIndicator" class="gesture-indicator">ì†ì„ ì¹´ë©”ë¼ì— ë³´ì—¬ì£¼ì„¸ìš”</div>
                <div id="fingerPoint" class="finger-point hidden"></div>
                
                <!-- ìŠ¬ë¼ì´ë“œ íˆ´ë°” -->
                <div id="slideToolbar" class="slide-toolbar">
                    <div class="tool-section">
                        <div class="tool-title">íœ êµµê¸°</div>
                        <div>
                            <div class="pen-size-option active" data-size="4">
                                <div class="pen-size-preview" style="width: 4px; height: 4px;"></div>
                            </div>
                            <div class="pen-size-option" data-size="8">
                                <div class="pen-size-preview" style="width: 8px; height: 8px;"></div>
                            </div>
                            <div class="pen-size-option" data-size="12">
                                <div class="pen-size-preview" style="width: 12px; height: 12px;"></div>
                            </div>
                            <div class="pen-size-option" data-size="16">
                                <div class="pen-size-preview" style="width: 16px; height: 16px;"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="tool-section">
                        <div class="tool-title">íœ ìƒ‰ìƒ</div>
                        <div>
                            <div class="color-option active" data-color="#3b82f6" style="background: #3b82f6;"></div>
                            <div class="color-option" data-color="#ef4444" style="background: #ef4444;"></div>
                            <div class="color-option" data-color="#10b981" style="background: #10b981;"></div>
                            <div class="color-option" data-color="#f59e0b" style="background: #f59e0b;"></div>
                            <div class="color-option" data-color="#8b5cf6" style="background: #8b5cf6;"></div>
                            <div class="color-option" data-color="#06b6d4" style="background: #06b6d4;"></div>
                            <div class="color-option" data-color="#84cc16" style="background: #84cc16;"></div>
                            <div class="color-option" data-color="#374151" style="background: #374151;"></div>
                        </div>
                    </div>
                </div>
                
                <!-- ìŠ¬ë¼ì´ë“œ íŠ¸ë¦¬ê±° ì˜ì—­ -->
                <div class="slide-trigger"></div>
                
                <!-- íŒì—… ë‚´ ë²„íŠ¼ë“¤ -->
                <button id="clearBtnPopup" class="popup-button clear-btn">
                    ğŸ—‘ï¸ ì§€ìš°ê¸°
                </button>
                <button id="completeBtnPopup" class="popup-button complete-btn">
                    âœ… ì™„ë£Œ
                </button>
            </div>
            
            <!-- ì œìŠ¤ì²˜ ì•ˆë‚´ -->
            <div class="mt-6 bg-blue-50 border-2 border-blue-200 rounded-2xl p-4">
                <h3 class="font-semibold text-blue-800 mb-2">âœ‹ ì œìŠ¤ì²˜ ì‚¬ìš©ë²•</h3>
                <div class="text-sm text-blue-700 space-y-1">
                    <p>â€¢ <strong>ê²€ì§€ì†ê°€ë½ë§Œ</strong> í´ì„œ í—ˆê³µì— í•œìë¥¼ ì¨ì£¼ì„¸ìš”</p>
                    <p>â€¢ <strong>ê²€ì§€+ì¤‘ì§€ë¥¼ ë¶™ì—¬ì„œ</strong> í´ë©´ ë²„íŠ¼ì„ í´ë¦­í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</p>
                    <p>â€¢ <strong>ì˜¤ë¥¸ìª½ ê°€ì¥ìë¦¬</strong>ë¡œ ì†ì„ ê°€ì ¸ê°€ë©´ ë„êµ¬ ë©”ë‰´ê°€ ë‚˜íƒ€ë‚©ë‹ˆë‹¤</p>
                    <p>â€¢ <strong>ì£¼ë¨¹ì„ ì¥ë©´</strong> ê·¸ë¦¬ê¸°ê°€ ë©ˆì¶¥ë‹ˆë‹¤</p>
                </div>
            </div>
        </div>
    </div>

    <!-- í•™ìŠµ ì¢…ë£Œ ëª¨ë‹¬ -->
    <div id="endModal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-3xl shadow-2xl p-10 w-full max-w-lg">
            <div class="text-center mb-8">
                <div class="text-6xl mb-4">ğŸ‰</div>
                <h2 class="text-3xl font-bold text-gray-800 mb-4">í•™ìŠµ ì™„ë£Œ!</h2>
            </div>
            <div class="mb-8 text-center">
                <p class="text-gray-600 mb-3 text-lg">ìµœì¢… ì ìˆ˜: <span id="finalScore" class="font-bold text-blue-600 text-2xl"></span>/250</p>
                <p class="text-gray-600 text-lg">ì •ë‹µë¥ : <span id="accuracy" class="font-bold text-green-600 text-2xl"></span>%</p>
            </div>
            <div class="mb-8">
                <label class="block text-sm font-semibold text-gray-700 mb-3">ê²°ê³¼ ì „ì†¡ ì´ë©”ì¼</label>
                <input type="email" id="resultEmail" 
                       class="w-full px-5 py-4 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 text-lg">
            </div>
            <div class="flex space-x-4">
                <button id="sendResultBtn" class="flex-1 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white py-4 px-6 rounded-xl font-semibold transition">
                    ğŸ“§ ê²°ê³¼ ì „ì†¡
                </button>
                <button id="closeModalBtn" class="flex-1 bg-gradient-to-r from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700 text-white py-4 px-6 rounded-xl font-semibold transition">
                    âŒ ë‹«ê¸°
                </button>
            </div>
        </div>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜
        let video, canvas, ctx;
        let hands, camera;
        let isDrawing = false;
        let lastPoint = null;
        let drawingPoints = [];
        let currentQuestionIndex = 0;
        let totalScore = 0;
        let answerData = null;
        let studentData = {};
        let scores = [];
        let fingerPoint = null;
        let gestureIndicator = null;
        let isPopupOpen = false;
        let lastClickTime = 0;
        
        // íœ ì„¤ì •
        let currentPenSize = 4;
        let currentPenColor = '#3b82f6';
        let slideToolbar = null;

        // ìƒ˜í”Œ ë‹µì•ˆ ë°ì´í„°
        const sampleAnswerData = {
            filename: Array.from({length: 25}, (_, i) => String(i + 1).padStart(2, '0') + '.png'),
            meaning: ['ë°°', 'ì†ë°”ë‹¥', 'ì„ ìƒë‹˜', 'í•™ìƒ', 'ì±…', 'ì—°í•„', 'ì§€ìš°ê°œ', 'ì¹ íŒ', 'êµì‹¤', 'ìˆ™ì œ', 
                     'ì‹œí—˜', 'ì ìˆ˜', 'í•©ê²©', 'ë¶ˆí•©ê²©', 'ì¡¸ì—…', 'ì…í•™', 'ë°©í•™', 'ê°œí•™', 'ìˆ˜ì—…', 'ê³¼ëª©',
                     'êµ­ì–´', 'ìˆ˜í•™', 'ì˜ì–´', 'ê³¼í•™', 'ì‚¬íšŒ'],
            sound: ['ë¦¬', 'ì¥', 'ì„ ', 'ìƒ', 'ì±…', 'ì—°', 'ì§€', 'ì¹ ', 'êµ', 'ìˆ™',
                   'ì‹œ', 'ì ', 'í•©', 'ë¶ˆ', 'ì¡¸', 'ì…', 'ë°©', 'ê°œ', 'ìˆ˜', 'ê³¼',
                   'êµ­', 'ìˆ˜', 'ì˜', 'ê³¼', 'ì‚¬']
        };

        // ì´ˆê¸°í™”
        async function init() {
            answerData = sampleAnswerData;
            setupEventListeners();
        }

        // ì¹´ë©”ë¼ ì´ˆê¸°í™”
        async function initCamera() {
            if (video && video.srcObject) return;

            video = document.getElementById('videoElement');
            canvas = document.getElementById('drawingCanvas');
            ctx = canvas.getContext('2d');
            fingerPoint = document.getElementById('fingerPoint');
            gestureIndicator = document.getElementById('gestureIndicator');
            slideToolbar = document.getElementById('slideToolbar');

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        width: 800, 
                        height: 600,
                        facingMode: 'user'
                    } 
                });
                video.srcObject = stream;
                
                return new Promise(resolve => {
                    video.onloadedmetadata = () => {
                        resolve();
                    };
                });
            } catch (err) {
                console.error('ì¹´ë©”ë¼ ì ‘ê·¼ ì˜¤ë¥˜:', err);
                alert('ì¹´ë©”ë¼ì— ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
            }
        }

        // MediaPipe ì´ˆê¸°í™”
        async function initMediaPipe() {
            if (hands) return;

            hands = new Hands({
                locateFile: (file) => {
                    return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
                }
            });

            hands.setOptions({
                maxNumHands: 1,
                modelComplexity: 1,
                minDetectionConfidence: 0.7,
                minTrackingConfidence: 0.5
            });

            hands.onResults(onHandResults);

            camera = new Camera(video, {
                onFrame: async () => {
                    await hands.send({image: video});
                },
                width: 800,
                height: 600
            });

            camera.start();
        }

        // ì† ê°ì§€ ê²°ê³¼ ì²˜ë¦¬
        function onHandResults(results) {
            if (!isPopupOpen) return;

            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                const landmarks = results.multiHandLandmarks[0];
                
                // ì†ê°€ë½ ë ì¢Œí‘œë“¤
                const indexTip = landmarks[8];
                const middleTip = landmarks[12];
                const indexPip = landmarks[6];
                const middlePip = landmarks[10];
                const indexMcp = landmarks[5];
                const thumbTip = landmarks[4];
                const ringTip = landmarks[16];
                const pinkyTip = landmarks[20];
                
                // ìº”ë²„ìŠ¤ ì¢Œí‘œë¡œ ë³€í™˜ (ì¢Œìš° ë°˜ì „)
                const x = (1 - indexTip.x) * canvas.width;
                const y = indexTip.y * canvas.height;
                
                // ì†ê°€ë½ í¬ì¸í„° í‘œì‹œ
                fingerPoint.style.left = x + 'px';
                fingerPoint.style.top = y + 'px';
                fingerPoint.classList.remove('hidden');
                
                // ì†ê°€ë½ ìƒíƒœ í™•ì¸
                const isIndexExtended = indexTip.y < indexPip.y && indexPip.y < indexMcp.y;
                const isMiddleExtended = middleTip.y < middlePip.y;
                const isThumbExtended = thumbTip.x > indexMcp.x;
                const isRingFolded = ringTip.y > landmarks[13].y;
                const isPinkyFolded = pinkyTip.y > landmarks[17].y;
                
                // ê²€ì§€ì™€ ì¤‘ì§€ê°€ ë¶™ì–´ìˆëŠ”ì§€ í™•ì¸
                const fingerDistance = Math.sqrt(
                    Math.pow((indexTip.x - middleTip.x) * canvas.width, 2) + 
                    Math.pow((indexTip.y - middleTip.y) * canvas.height, 2)
                );
                const fingersClose = fingerDistance < 30;
                
                // ìŠ¬ë¼ì´ë“œ íˆ´ë°” ì œì–´ (ì˜¤ë¥¸ìª½ ê°€ì¥ìë¦¬ 50px)
                if (x > canvas.width - 50) {
                    slideToolbar.classList.add('active');
                } else if (x < canvas.width - 200) {
                    slideToolbar.classList.remove('active');
                }
                
                // ì œìŠ¤ì²˜ ì¸ì‹
                if (isIndexExtended && isMiddleExtended && fingersClose && isRingFolded && isPinkyFolded) {
                    // ê²€ì§€+ì¤‘ì§€ ë¶™ì—¬ì„œ í´ê¸° = í´ë¦­ ëª¨ë“œ
                    gestureIndicator.textContent = 'í´ë¦­ ëª¨ë“œ ğŸ‘†';
                    gestureIndicator.style.background = 'rgba(239, 68, 68, 0.8)';
                    fingerPoint.className = 'finger-point clicking';
                    
                    stopDrawing();
                    checkButtonClick(x, y);
                    checkToolbarClick(x, y);
                    
                } else if (isIndexExtended && !isMiddleExtended && isRingFolded && isPinkyFolded) {
                    // ê²€ì§€ë§Œ í´ê¸° = ê·¸ë¦¬ê¸° ëª¨ë“œ
                    gestureIndicator.textContent = 'ê·¸ë¦¬ê¸° ëª¨ë“œ âœï¸';
                    gestureIndicator.style.background = 'rgba(34, 197, 94, 0.8)';
                    fingerPoint.className = 'finger-point drawing';
                    
                    if (isInDrawingArea(x, y)) {
                        addDrawingPoint(x, y);
                    }
                } else {
                    // ê¸°íƒ€ = ì •ì§€ ëª¨ë“œ
                    gestureIndicator.textContent = 'ì •ì§€ ëª¨ë“œ âœ‹';
                    gestureIndicator.style.background = 'rgba(59, 130, 246, 0.8)';
                    fingerPoint.className = 'finger-point';
                    stopDrawing();
                }
                
            } else {
                fingerPoint.classList.add('hidden');
                gestureIndicator.textContent = 'ì†ì„ ì¹´ë©”ë¼ì— ë³´ì—¬ì£¼ì„¸ìš”';
                gestureIndicator.style.background = 'rgba(0, 0, 0, 0.7)';
                slideToolbar.classList.remove('active');
                stopDrawing();
            }
        }

        // ê·¸ë¦¬ê¸° ì˜ì—­ í™•ì¸
        function isInDrawingArea(x, y) {
            const margin = 50;
            return x > margin && x < canvas.width - 250 && // ì˜¤ë¥¸ìª½ íˆ´ë°” ì˜ì—­ ì œì™¸
                   y > margin && y < canvas.height - 150;
        }

        // ë²„íŠ¼ í´ë¦­ í™•ì¸
        function checkButtonClick(x, y) {
            const currentTime = Date.now();
            if (currentTime - lastClickTime < 500) return;
            
            const clearBtnArea = { x: 50, y: canvas.height - 100, width: 180, height: 60 };
            const completeBtnArea = { x: canvas.width - 230, y: canvas.height - 100, width: 180, height: 60 };
            
            if (isPointInArea(x, y, clearBtnArea)) {
                lastClickTime = currentTime;
                document.getElementById('clearBtnPopup').classList.add('active');
                setTimeout(() => {
                    document.getElementById('clearBtnPopup').classList.remove('active');
                    clearDrawing();
                }, 200);
            } else if (isPointInArea(x, y, completeBtnArea)) {
                lastClickTime = currentTime;
                document.getElementById('completeBtnPopup').classList.add('active');
                setTimeout(() => {
                    document.getElementById('completeBtnPopup').classList.remove('active');
                    completeDrawing();
                }, 200);
            }
        }

        // íˆ´ë°” í´ë¦­ í™•ì¸
        function checkToolbarClick(x, y) {
            if (!slideToolbar.classList.contains('active')) return;
            
            const currentTime = Date.now();
            if (currentTime - lastClickTime < 300) return;
            
            // íœ í¬ê¸° ì„ íƒ
            document.querySelectorAll('.pen-size-option').forEach(option => {
                const rect = option.getBoundingClientRect();
                const canvasRect = canvas.getBoundingClientRect();
                const optionX = rect.left - canvasRect.left;
                const optionY = rect.top - canvasRect.top;
                const optionArea = {
                    x: optionX, y: optionY,
                    width: rect.width, height: rect.height
                };
                
                if (isPointInArea(x, y, optionArea)) {
                    lastClickTime = currentTime;
                    document.querySelectorAll('.pen-size-option').forEach(o => o.classList.remove('active'));
                    option.classList.add('active');
                    currentPenSize = parseInt(option.dataset.size);
                }
            });
            
            // íœ ìƒ‰ìƒ ì„ íƒ
            document.querySelectorAll('.color-option').forEach(option => {
                const rect = option.getBoundingClientRect();
                const canvasRect = canvas.getBoundingClientRect();
                const optionX = rect.left - canvasRect.left;
                const optionY = rect.top - canvasRect.top;
                const optionArea = {
                    x: optionX, y: optionY,
                    width: rect.width, height: rect.height
                };
                
                if (isPointInArea(x, y, optionArea)) {
                    lastClickTime = currentTime;
                    document.querySelectorAll('.color-option').forEach(o => o.classList.remove('active'));
                    option.classList.add('active');
                    currentPenColor = option.dataset.color;
                }
            });
        }

        // í¬ì¸íŠ¸ê°€ ì˜ì—­ ì•ˆì— ìˆëŠ”ì§€ í™•ì¸
        function isPointInArea(x, y, area) {
            return x >= area.x && x <= area.x + area.width && 
                   y >= area.y && y <= area.y + area.height;
        }

        // ê·¸ë¦¬ê¸° í¬ì¸íŠ¸ ì¶”ê°€
        function addDrawingPoint(x, y) {
            if (lastPoint) {
                const distance = Math.sqrt(
                    Math.pow(x - lastPoint.x, 2) + Math.pow(y - lastPoint.y, 2)
                );
                
                if (distance > 5) {
                    ctx.strokeStyle = currentPenColor;
                    ctx.lineWidth = currentPenSize;
                    ctx.lineCap = 'round';
                    ctx.lineJoin = 'round';
                    ctx.beginPath();
                    ctx.moveTo(lastPoint.x, lastPoint.y);
                    ctx.lineTo(x, y);
                    ctx.stroke();
                    
                    // ì‹œê°ì  íš¨ê³¼ ì¶”ê°€
                    const trail = document.createElement('div');
                    trail.className = 'drawing-trail';
                    trail.style.left = (x - 6) + 'px';
                    trail.style.top = (y - 6) + 'px';
                    trail.style.background = `radial-gradient(circle, ${currentPenColor} 0%, ${currentPenColor}80 100%)`;
                    canvas.parentElement.appendChild(trail);
                    
                    setTimeout(() => trail.remove(), 1500);
                }
            }
            
            drawingPoints.push({ x, y, timestamp: Date.now() });
            lastPoint = { x, y };
        }

        // ê·¸ë¦¬ê¸° ì¤‘ì§€
        function stopDrawing() {
            lastPoint = null;
        }

        // íŒì—… ì—´ê¸°
        async function openDrawingPopup() {
            document.getElementById('drawingPopup').classList.remove('hidden');
            isPopupOpen = true;
            
            await initCamera();
            await initMediaPipe();
            
            clearDrawing();
        }

        // íŒì—… ë‹«ê¸°
        function closeDrawingPopup() {
            document.getElementById('drawingPopup').classList.add('hidden');
            isPopupOpen = false;
            
            if (video && video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
                video.srcObject = null;
            }
            
            slideToolbar.classList.remove('active');
        }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        function setupEventListeners() {
            document.getElementById('studentForm').addEventListener('submit', startLearning);
            document.getElementById('openDrawingBtn').addEventListener('click', openDrawingPopup);
            document.getElementById('clearBtnPopup').addEventListener('click', clearDrawing);
            document.getElementById('completeBtnPopup').addEventListener('click', completeDrawing);
            document.getElementById('nextBtn').addEventListener('click', nextQuestion);
            document.getElementById('endLearningBtn').addEventListener('click', endLearning);
            document.getElementById('sendResultBtn').addEventListener('click', sendResult);
            document.getElementById('closeModalBtn').addEventListener('click', closeModal);
            
            // íŒì—… ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
            document.getElementById('drawingPopup').addEventListener('click', (e) => {
                if (e.target.id === 'drawingPopup') {
                    closeDrawingPopup();
                }
            });
            
            // ESC í‚¤ë¡œ íŒì—… ë‹«ê¸°
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && isPopupOpen) {
                    closeDrawingPopup();
                }
            });
            
            // íœ í¬ê¸° ì„ íƒ ì´ë²¤íŠ¸
            document.querySelectorAll('.pen-size-option').forEach(option => {
                option.addEventListener('click', () => {
                    document.querySelectorAll('.pen-size-option').forEach(o => o.classList.remove('active'));
                    option.classList.add('active');
                    currentPenSize = parseInt(option.dataset.size);
                });
            });
            
            // íœ ìƒ‰ìƒ ì„ íƒ ì´ë²¤íŠ¸
            document.querySelectorAll('.color-option').forEach(option => {
                option.addEventListener('click', () => {
                    document.querySelectorAll('.color-option').forEach(o => o.classList.remove('active'));
                    option.classList.add('active');
                    currentPenColor = option.dataset.color;
                });
            });
        }

        // í•™ìŠµ ì‹œì‘
        function startLearning(e) {
            e.preventDefault();
            
            studentData = {
                name: document.getElementById('studentName').value,
                grade: document.getElementById('studentGrade').value,
                class: document.getElementById('studentClass').value,
                number: document.getElementById('studentNumber').value,
                email: document.getElementById('studentEmail').value
            };
            
            document.getElementById('studentInfoScreen').classList.add('hidden');
            document.getElementById('learningScreen').classList.remove('hidden');
            
            document.getElementById('studentInfo').textContent = 
                `${studentData.grade}í•™ë…„ ${studentData.class}ë°˜ ${studentData.number}ë²ˆ ${studentData.name}`;
            
            loadQuestion();
        }

        // ë¬¸ì œ ë¡œë“œ
        function loadQuestion() {
            if (currentQuestionIndex >= answerData.filename.length) {
                endLearning();
                return;
            }
            
            document.getElementById('characterMeaning').textContent = answerData.meaning[currentQuestionIndex];
            document.getElementById('characterSound').textContent = answerData.sound[currentQuestionIndex];
            document.getElementById('answerImage').src = `images/${answerData.filename[currentQuestionIndex]}`;
            document.getElementById('currentQuestion').textContent = currentQuestionIndex + 1;
            
            document.getElementById('nextBtn').disabled = true;
            document.getElementById('resultPanel').innerHTML = '<div class="text-center text-gray-500 p-8 bg-gray-50 rounded-2xl">í—ˆê³µì— í•œìë¥¼ ì¨ì£¼ì„¸ìš”</div>';
        }

        // ê·¸ë¦¬ê¸° ì§€ìš°ê¸°
        function clearDrawing() {
            if (ctx) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            }
            drawingPoints = [];
            lastPoint = null;
        }

        // ê·¸ë¦¬ê¸° ì™„ë£Œ
        function completeDrawing() {
            if (drawingPoints.length === 0) {
                alert('í•œìë¥¼ ì¨ì£¼ì„¸ìš”!');
                return;
            }
            
            const score = evaluateDrawing();
            scores.push(score);
            totalScore += score;
            
            document.getElementById('currentScore').textContent = totalScore;
            
            const resultPanel = document.getElementById('resultPanel');
            const isCorrect = score > 5;
            
            resultPanel.innerHTML = `
                <div class="text-center p-6 rounded-2xl ${isCorrect ? 'bg-green-50' : 'bg-red-50'}">
                    <div class="text-6xl mb-4">${isCorrect ? 'ğŸ‰' : 'ğŸ˜”'}</div>
                    <div class="text-2xl font-bold ${isCorrect ? 'text-green-600' : 'text-red-600'} mb-2">
                        ${isCorrect ? 'ì •ë‹µ!' : 'ì˜¤ë‹µ'}
                    </div>
                    <div class="text-xl text-gray-600">ì ìˆ˜: ${score}/10</div>
                </div>
            `;
            
            document.getElementById('nextBtn').disabled = false;
            saveToCsv(score);
            closeDrawingPopup();
        }

        // ê°„ë‹¨í•œ ì±„ì  í•¨ìˆ˜
        function evaluateDrawing() {
            const strokeCount = Math.floor(drawingPoints.length / 15);
            const complexity = calculateComplexity();
            const baseScore = Math.min(strokeCount, 7);
            const complexityBonus = Math.min(complexity, 3);
            return Math.min(baseScore + complexityBonus, 10);
        }

        // ë³µì¡ë„ ê³„ì‚°
        function calculateComplexity() {
            if (drawingPoints.length < 10) return 0;
            
            let directionChanges = 0;
            for (let i = 2; i < drawingPoints.length; i++) {
                const prev = drawingPoints[i-2];
                const curr = drawingPoints[i-1];
                const next = drawingPoints[i];
                
                const angle1 = Math.atan2(curr.y - prev.y, curr.x - prev.x);
                const angle2 = Math.atan2(next.y - curr.y, next.x - curr.x);
                const angleDiff = Math.abs(angle2 - angle1);
                
                if (angleDiff > Math.PI / 4) {
                    directionChanges++;
                }
            }
            
            return Math.min(Math.floor(directionChanges / 3), 3);
        }

        // CSV ì €ì¥
        function saveToCsv(score) {
            const csvData = `${studentData.name},${studentData.grade},${studentData.class},${studentData.number},${studentData.email},${currentQuestionIndex + 1},${score},${new Date().toISOString()}\n`;
            localStorage.setItem('myscore_' + Date.now(), csvData);
        }

        // ë‹¤ìŒ ë¬¸ì œ
        function nextQuestion() {
            currentQuestionIndex++;
            loadQuestion();
        }

        // í•™ìŠµ ì¢…ë£Œ
        function endLearning() {
            const accuracy = Math.round((scores.filter(s => s > 5).length / Math.max(scores.length, 1)) * 100);
            
            document.getElementById('finalScore').textContent = totalScore;
            document.getElementById('accuracy').textContent = accuracy;
            document.getElementById('resultEmail').value = studentData.email;
            document.getElementById('endModal').classList.remove('hidden');
        }

        // ê²°ê³¼ ì „ì†¡
        function sendResult() {
            const email = document.getElementById('resultEmail').value;
            if (!email) {
                alert('ì´ë©”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!');
                return;
            }
            
            const resultData = {
                student: studentData,
                totalScore: totalScore,
                accuracy: Math.round((scores.filter(s => s > 5).length / Math.max(scores.length, 1)) * 100),
                scores: scores,
                timestamp: new Date().toISOString()
            };
            
            console.log('ê²°ê³¼ ì „ì†¡:', resultData);
            alert(`í•™ìŠµ ê²°ê³¼ê°€ ${email}ë¡œ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤!`);
            closeModal();
        }

        // ëª¨ë‹¬ ë‹«ê¸°
        function closeModal() {
            document.getElementById('endModal').classList.add('hidden');
            location.reload();
        }

        // í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ í›„ ì´ˆê¸°í™”
        window.addEventListener('load', () => {
            init().catch(console.error);
        });
    </script>
</body>
</html>