<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÌïúÏûê ÏóêÏñ¥ ÌéòÏù∏ÌåÖ ÌïôÏäµ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <style>
        .canvas-container {
            position: relative;
            border: 4px solid #3b82f6;
            border-radius: 16px;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }
        .drawing-trail {
            position: absolute;
            width: 12px;
            height: 12px;
            background: radial-gradient(circle, #3b82f6 0%, #1d4ed8 100%);
            border-radius: 50%;
            pointer-events: none;
            animation: trailFade 1.5s ease-out forwards;
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.6);
        }
        @keyframes trailFade {
            0% { opacity: 1; transform: scale(1); }
            100% { opacity: 0; transform: scale(0.3); }
        }
        .gesture-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            z-index: 10;
        }
        .writing-area {
            background: rgba(0, 0, 0, 0.3);
            border: 2px dashed #ffffff;
            border-radius: 12px;
        }
        .popup-button {
            position: absolute;
            bottom: 20px;
            background: rgba(255, 255, 255, 0.95);
            border: 3px solid #e2e8f0;
            border-radius: 16px;
            padding: 16px 32px;
            font-weight: 700;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 20px -2px rgba(0, 0, 0, 0.15);
            z-index: 20;
        }
        .popup-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 25px -5px rgba(0, 0, 0, 0.2);
        }
        .popup-button.active {
            transform: scale(1.1);
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.3);
        }
        .clear-btn {
            left: 50px;
            background: #ef4444;
            color: white;
            border-color: #dc2626;
        }
        .complete-btn {
            right: 50px;
            background: #10b981;
            color: white;
            border-color: #059669;
        }
        .finger-point {
            position: absolute;
            width: 24px;
            height: 24px;
            background: #f59e0b;
            border: 4px solid #ffffff;
            border-radius: 50%;
            pointer-events: none;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 20px rgba(245, 158, 11, 0.8);
            animation: fingerPulse 1s infinite;
            z-index: 15;
        }
        .finger-point.drawing {
            background: #3b82f6;
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.8);
        }
        .finger-point.clicking {
            background: #ef4444;
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.8);
            animation: clickPulse 0.3s ease-out;
        }
        @keyframes fingerPulse {
            0%, 100% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.2); }
        }
        @keyframes clickPulse {
            0% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.5); }
            100% { transform: translate(-50%, -50%) scale(1); }
        }
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .popup-content {
            background: white;
            border-radius: 24px;
            padding: 24px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            max-width: 95vw;
            max-height: 95vh;
        }
        
        /* Ïä¨ÎùºÏù¥Îìú Ìà¥Î∞î */
        .slide-toolbar {
            position: absolute;
            right: -200px;
            top: 50%;
            transform: translateY(-50%);
            width: 200px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px 0 0 20px;
            padding: 20px;
            box-shadow: -5px 0 20px rgba(0, 0, 0, 0.2);
            transition: right 0.3s ease;
            z-index: 25;
        }
        .slide-toolbar.active {
            right: 0;
        }
        .slide-trigger {
            position: absolute;
            right: 0;
            top: 0;
            width: 50px;
            height: 100%;
            z-index: 30;
        }
        .tool-section {
            margin-bottom: 20px;
        }
        .tool-title {
            font-size: 14px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 10px;
        }
        .pen-size-option {
            width: 40px;
            height: 40px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            margin: 5px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .pen-size-option.active {
            border-color: #3b82f6;
            background: #eff6ff;
        }
        .pen-size-preview {
            background: #374151;
            border-radius: 50%;
        }
        .color-option {
            width: 40px;
            height: 40px;
            border: 2px solid #e5e7eb;
            border-radius: 50%;
            margin: 5px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        .color-option.active {
            border-color: #374151;
            transform: scale(1.1);
        }
        .color-option::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: inherit;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 min-h-screen">
    <!-- ÌïôÏÉù Ï†ïÎ≥¥ ÏûÖÎ†• ÌôîÎ©¥ -->
    <div id="studentInfoScreen" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl shadow-2xl p-10 w-full max-w-lg">
            <div class="text-center mb-10">
                <div class="text-6xl mb-4">‚úã</div>
                <h1 class="text-4xl font-bold text-gray-800 mb-3">ÌïúÏûê ÏóêÏñ¥ ÌéòÏù∏ÌåÖ</h1>
                <p class="text-gray-600 text-lg">ÏÜêÍ∞ÄÎùΩÏúºÎ°ú ÌóàÍ≥µÏóê ÌïúÏûêÎ•º Ïç®Î≥¥ÏÑ∏Ïöî</p>
            </div>
            <form id="studentForm" class="space-y-6">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-3">Ïù¥Î¶Ñ</label>
                    <input type="text" id="studentName" required 
                           class="w-full px-5 py-4 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent text-lg">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-3">ÌïôÎÖÑ</label>
                        <select id="studentGrade" required class="w-full px-5 py-4 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 text-lg">
                            <option value="">ÏÑ†ÌÉù</option>
                            <option value="1">1ÌïôÎÖÑ</option>
                            <option value="2">2ÌïôÎÖÑ</option>
                            <option value="3">3ÌïôÎÖÑ</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-3">Î∞ò</label>
                        <input type="number" id="studentClass" min="1" max="20" required 
                               class="w-full px-5 py-4 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 text-lg">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-3">Î≤àÌò∏</label>
                    <input type="number" id="studentNumber" min="1" max="40" required 
                           class="w-full px-5 py-4 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 text-lg">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-3">Ïù¥Î©îÏùº</label>
                    <input type="email" id="studentEmail" required 
                           class="w-full px-5 py-4 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 text-lg">
                </div>
                <button type="submit" 
                        class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white font-bold py-4 px-6 rounded-xl transition duration-300 transform hover:scale-105 text-lg shadow-lg">
                    üöÄ ÌïúÏûêÏì∞Í∏∞ÌÖåÏä§Ìä∏ ÏãúÏûë
                </button>
            </form>
        </div>
    </div>

    <!-- Î©îÏù∏ ÌïôÏäµ ÌôîÎ©¥ -->
    <div id="learningScreen" class="hidden min-h-screen">
        <!-- Ìó§Îçî -->
        <div class="bg-white shadow-xl border-b-4 border-blue-200 p-6">
            <div class="max-w-7xl mx-auto flex justify-between items-center">
                <div class="flex items-center space-x-6">
                    <h1 class="text-3xl font-bold text-gray-800">‚úã ÌïúÏûê ÏóêÏñ¥ ÌéòÏù∏ÌåÖ</h1>
                    <div class="text-lg text-gray-600">
                        <span id="studentInfo"></span>
                    </div>
                </div>
                <div class="flex items-center space-x-6">
                    <div class="text-2xl font-bold text-blue-600 bg-blue-50 px-4 py-2 rounded-lg">
                        Ï†êÏàò: <span id="currentScore">0</span>/250
                    </div>
                    <div class="text-lg text-gray-600 bg-gray-50 px-4 py-2 rounded-lg">
                        Î¨∏Ï†ú: <span id="currentQuestion">1</span>/25
                    </div>
                </div>
            </div>
        </div>

        <!-- Î©îÏù∏ Ïª®ÌÖêÏ∏† -->
        <div class="max-w-7xl mx-auto p-6">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Î¨∏Ï†ú Ï†ïÎ≥¥ Ìå®ÎÑê -->
                <div class="bg-white rounded-3xl shadow-xl p-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                        üìö Î¨∏Ï†ú Ï†ïÎ≥¥
                    </h2>
                    <div class="space-y-6">
                        <div class="p-6 bg-gradient-to-br from-blue-50 to-blue-100 rounded-2xl">
                            <label class="block text-sm font-semibold text-gray-700 mb-3">Îúª</label>
                            <div id="characterMeaning" class="text-3xl font-bold text-blue-600"></div>
                        </div>
                        <div class="p-6 bg-gradient-to-br from-green-50 to-green-100 rounded-2xl">
                            <label class="block text-sm font-semibold text-gray-700 mb-3">Ïùå</label>
                            <div id="characterSound" class="text-3xl font-bold text-green-600"></div>
                        </div>
                        <div class="p-6 bg-gradient-to-br from-gray-50 to-gray-100 rounded-2xl">
                            <label class="block text-sm font-semibold text-gray-700 mb-3">Ï†ïÎãµ ÌïúÏûê</label>
                            <div class="bg-white p-4 rounded-xl border-2 border-gray-200">
                                <img id="answerImage" src="" alt="Ï†ïÎãµ ÌïúÏûê" class="w-32 h-32 mx-auto object-contain">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Í∑∏Î¶¨Í∏∞ ÏãúÏûë Î≤ÑÌäº ÏòÅÏó≠ -->
                <div class="lg:col-span-2 bg-white rounded-3xl shadow-xl p-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                        ‚úã ÌïúÏûê Ïì∞Í∏∞
                    </h2>
                    <div class="text-center">
                        <div class="bg-gradient-to-br from-blue-50 to-indigo-100 rounded-2xl p-12 mb-6">
                            <div class="text-8xl mb-6">üé®</div>
                            <h3 class="text-2xl font-bold text-gray-800 mb-4">ÌóàÍ≥µÏóê ÌïúÏûêÎ•º Ïç®Î≥¥ÏÑ∏Ïöî</h3>
                            <p class="text-gray-600 mb-8">ÌåùÏóÖ Ï∞ΩÏóêÏÑú ÏÜêÍ∞ÄÎùΩÏúºÎ°ú ÌïúÏûêÎ•º Í∑∏Î†§Ï£ºÏÑ∏Ïöî</p>
                        </div>
                        <button id="openDrawingBtn" 
                                class="bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white font-bold py-4 px-8 rounded-xl transition duration-300 transform hover:scale-105 text-xl shadow-lg">
                            üñåÔ∏è Í∑∏Î¶¨Í∏∞ ÏãúÏûë
                        </button>
                    </div>
                </div>
            </div>

            <!-- Í≤∞Í≥º Î∞è Ï†úÏñ¥ Ìå®ÎÑê -->
            <div class="mt-6 bg-white rounded-3xl shadow-xl p-8">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                            üìä Í≤∞Í≥º
                        </h2>
                        <div id="resultPanel" class="space-y-4">
                            <div class="text-center text-gray-500 p-8 bg-gray-50 rounded-2xl">
                                ÌóàÍ≥µÏóê ÌïúÏûêÎ•º Ïç®Ï£ºÏÑ∏Ïöî
                            </div>
                        </div>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                            üéÆ Ï†úÏñ¥
                        </h2>
                        <div class="space-y-4">
                            <button id="nextBtn" disabled class="w-full bg-gradient-to-r from-blue-500 to-indigo-500 hover:from-blue-600 hover:to-indigo-600 disabled:from-gray-300 disabled:to-gray-300 text-white py-4 px-6 rounded-xl transition font-semibold text-lg">
                                ‚û°Ô∏è Îã§Ïùå Î¨∏Ï†ú
                            </button>
                            <button id="endLearningBtn" class="w-full bg-gradient-to-r from-red-500 to-pink-500 hover:from-red-600 hover:to-pink-600 text-white py-4 px-6 rounded-xl transition font-semibold text-lg">
                                üèÅ ÌïôÏäµ Ï¢ÖÎ£å
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Í∑∏Î¶¨Í∏∞ ÌåùÏóÖ -->
    <div id="drawingPopup" class="hidden popup-overlay">
        <div class="popup-content">
            <div class="canvas-container">
                <video id="videoElement" width="800" height="600" autoplay muted class="rounded-2xl opacity-60" style="transform: scaleX(-1);"></video>
                <canvas id="drawingCanvas" width="800" height="600" class="absolute top-0 left-0 rounded-2xl writing-area"></canvas>
                <div id="gestureIndicator" class="gesture-indicator">ÏÜêÏùÑ Ïπ¥Î©îÎùºÏóê Î≥¥Ïó¨Ï£ºÏÑ∏Ïöî</div>
                <div id="fingerPoint" class="finger-point hidden"></div>
                
                <!-- Ïä¨ÎùºÏù¥Îìú Ìà¥Î∞î -->
                <div id="slideToolbar" class="slide-toolbar">
                    <div class="tool-section">
                        <div class="tool-title">Ìéú ÍµµÍ∏∞</div>
                        <div>
                            <div class="pen-size-option active" data-size="4">
                                <div class="pen-size-preview" style="width: 4px; height: 4px;"></div>
                            </div>
                            <div class="pen-size-option" data-size="8">
                                <div class="pen-size-preview" style="width: 8px; height: 8px;"></div>
                            </div>
                            <div class="pen-size-option" data-size="12">
                                <div class="pen-size-preview" style="width: 12px; height: 12px;"></div>
                            </div>
                            <div class="pen-size-option" data-size="16">
                                <div class="pen-size-preview" style="width: 16px; height: 16px;"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="tool-section">
                        <div class="tool-title">Ìéú ÏÉâÏÉÅ</div>
                        <div>
                            <div class="color-option active" data-color="#3b82f6" style="background: #3b82f6;"></div>
                            <div class="color-option" data-color="#ef4444" style="background: #ef4444;"></div>
                            <div class="color-option" data-color="#10b981" style="background: #10b981;"></div>
                            <div class="color-option" data-color="#f59e0b" style="background: #f59e0b;"></div>
                            <div class="color-option" data-color="#8b5cf6" style="background: #8b5cf6;"></div>
                            <div class="color-option" data-color="#06b6d4" style="background: #06b6d4;"></div>
                            <div class="color-option" data-color="#84cc16" style="background: #84cc16;"></div>
                            <div class="color-option" data-color="#374151" style="background: #374151;"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Ïä¨ÎùºÏù¥Îìú Ìä∏Î¶¨Í±∞ ÏòÅÏó≠ -->
                <div class="slide-trigger"></div>
                
                <!-- ÌåùÏóÖ ÎÇ¥ Î≤ÑÌäºÎì§ -->
                <button id="clearBtnPopup" class="popup-button clear-btn">
                    üóëÔ∏è ÏßÄÏö∞Í∏∞
                </button>
                <button id="completeBtnPopup" class="popup-button complete-btn">
                    ‚úÖ ÏôÑÎ£å
                </button>
            </div>
            
            <!-- Ï†úÏä§Ï≤ò ÏïàÎÇ¥ -->
            <div class="mt-6 bg-blue-50 border-2 border-blue-200 rounded-2xl p-4">
                <h3 class="font-semibold text-blue-800 mb-2">‚úã Ï†úÏä§Ï≤ò ÏÇ¨Ïö©Î≤ï</h3>
                <div class="text-sm text-blue-700 space-y-1">
                    <p>‚Ä¢ <strong>Í≤ÄÏßÄÏÜêÍ∞ÄÎùΩÎßå</strong> Ìé¥ÏÑú ÌóàÍ≥µÏóê ÌïúÏûêÎ•º Ïç®Ï£ºÏÑ∏Ïöî</p>
                    <p>‚Ä¢ <strong>Í≤ÄÏßÄ+Ï§ëÏßÄÎ•º Î∂ôÏó¨ÏÑú</strong> Ìé¥Î©¥ Î≤ÑÌäºÏùÑ ÌÅ¥Î¶≠Ìï† Ïàò ÏûàÏäµÎãàÎã§</p>
                    <p>‚Ä¢ <strong>Ïò§Î•∏Ï™Ω Í∞ÄÏû•ÏûêÎ¶¨</strong>Î°ú ÏÜêÏùÑ Í∞ÄÏ†∏Í∞ÄÎ©¥ ÎèÑÍµ¨ Î©îÎâ¥Í∞Ä ÎÇòÌÉÄÎÇ©ÎãàÎã§</p>
                    <p>‚Ä¢ <strong>Ï£ºÎ®πÏùÑ Ï•êÎ©¥</strong> Í∑∏Î¶¨Í∏∞Í∞Ä Î©àÏ∂•ÎãàÎã§</p>
                </div>
            </div>
        </div>
    </div>

    <!-- ÌïôÏäµ Ï¢ÖÎ£å Î™®Îã¨ -->
    <div id="endModal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-3xl shadow-2xl p-10 w-full max-w-lg">
            <div class="text-center mb-8">
                <div class="text-6xl mb-4">üéâ</div>
                <h2 class="text-3xl font-bold text-gray-800 mb-4">ÌïôÏäµ ÏôÑÎ£å!</h2>
            </div>
            <div class="mb-8 text-center">
                <p class="text-gray-600 mb-3 text-lg">ÏµúÏ¢Ö Ï†êÏàò: <span id="finalScore" class="font-bold text-blue-600 text-2xl"></span>/250</p>
                <p class="text-gray-600 text-lg">Ï†ïÎãµÎ•†: <span id="accuracy" class="font-bold text-green-600 text-2xl"></span>%</p>
            </div>
            <div class="mb-8">
                <label class="block text-sm font-semibold text-gray-700 mb-3">Í≤∞Í≥º Ï†ÑÏÜ° Ïù¥Î©îÏùº</label>
                <input type="email" id="resultEmail" 
                       class="w-full px-5 py-4 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 text-lg">
            </div>
            <div class="flex space-x-4">
                <button id="sendResultBtn" class="flex-1 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white py-4 px-6 rounded-xl font-semibold transition">
                    üìß Í≤∞Í≥º Ï†ÑÏÜ°
                </button>
                <button id="closeModalBtn" class="flex-1 bg-gradient-to-r from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700 text-white py-4 px-6 rounded-xl font-semibold transition">
                    ‚ùå Îã´Í∏∞
                </button>
            </div>
        </div>
    </div>

    <script>
        // Ï†ÑÏó≠ Î≥ÄÏàò
        let video, canvas, ctx;
        let hands, camera;
        let isDrawing = false;
        let lastPoint = null;
        let drawingPoints = [];
        let currentQuestionIndex = 0;
        let totalScore = 0;
        let answerData = null;
        let studentData = {};
        let scores = [];
        let fingerPoint = null;
        let gestureIndicator = null;
        let isPopupOpen = false;
        let lastClickTime = 0;
        
        // Ìéú ÏÑ§Ï†ï
        let currentPenSize = 4;
        let currentPenColor = '#3b82f6';
        let slideToolbar = null;

        // ÏÉòÌîå ÎãµÏïà Îç∞Ïù¥ÌÑ∞
        const sampleAnswerData = {
            filename: Array.from({length: 25}, (_, i) => String(i + 1).padStart(2, '0') + '.png'),
            meaning: ['Î∞∞', 'ÏÜêÎ∞îÎã•', 'ÏÑ†ÏÉùÎãò', 'ÌïôÏÉù', 'Ï±Ö', 'Ïó∞ÌïÑ', 'ÏßÄÏö∞Í∞ú', 'Ïπ†Ìåê', 'ÍµêÏã§', 'ÏàôÏ†ú', 
                     'ÏãúÌóò', 'Ï†êÏàò', 'Ìï©Í≤©', 'Î∂àÌï©Í≤©', 'Ï°∏ÏóÖ', 'ÏûÖÌïô', 'Î∞©Ìïô', 'Í∞úÌïô', 'ÏàòÏóÖ', 'Í≥ºÎ™©',
                     'Íµ≠Ïñ¥', 'ÏàòÌïô', 'ÏòÅÏñ¥', 'Í≥ºÌïô', 'ÏÇ¨Ìöå'],
            sound: ['Î¶¨', 'Ïû•', 'ÏÑ†', 'ÏÉù', 'Ï±Ö', 'Ïó∞', 'ÏßÄ', 'Ïπ†', 'Íµê', 'Ïàô',
                   'Ïãú', 'Ï†ê', 'Ìï©', 'Î∂à', 'Ï°∏', 'ÏûÖ', 'Î∞©', 'Í∞ú', 'Ïàò', 'Í≥º',
                   'Íµ≠', 'Ïàò', 'ÏòÅ', 'Í≥º', 'ÏÇ¨']
        };

        // Ï¥àÍ∏∞Ìôî
        async function init() {
            answerData = sampleAnswerData;
            setupEventListeners();
        }

        // Ïπ¥Î©îÎùº Ï¥àÍ∏∞Ìôî
        async function initCamera() {
            if (video && video.srcObject) return;

            video = document.getElementById('videoElement');
            canvas = document.getElementById('drawingCanvas');
            ctx = canvas.getContext('2d');
            fingerPoint = document.getElementById('fingerPoint');
            gestureIndicator = document.getElementById('gestureIndicator');
            slideToolbar = document.getElementById('slideToolbar');

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        width: 800, 
                        height: 600,
                        facingMode: 'user'
                    } 
                });
                video.srcObject = stream;
                
                return new Promise(resolve => {
                    video.onloadedmetadata = () => {
                        resolve();
                    };
                });
            } catch (err) {
                console.error('Ïπ¥Î©îÎùº Ï†ëÍ∑º Ïò§Î•ò:', err);
                alert('Ïπ¥Î©îÎùºÏóê Ï†ëÍ∑ºÌï† Ïàò ÏóÜÏäµÎãàÎã§. Î∏åÎùºÏö∞Ï†Ä ÏÑ§Ï†ïÏùÑ ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.');
            }
        }

        // MediaPipe Ï¥àÍ∏∞Ìôî
        async function initMediaPipe() {
            if (hands) return;

            hands = new Hands({
                locateFile: (file) => {
                    return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
                }
            });

            hands.setOptions({
                maxNumHands: 1,
                modelComplexity: 1,
                minDetectionConfidence: 0.7,
                minTrackingConfidence: 0.5
            });

            hands.onResults(onHandResults);

            camera = new Camera(video, {
                onFrame: async () => {
                    await hands.send({image: video});
                },
                width: 800,
                height: 600
            });

            camera.start();
        }

        // ÏÜê Í∞êÏßÄ Í≤∞Í≥º Ï≤òÎ¶¨
        function onHandResults(results) {
            if (!isPopupOpen) return;

            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                const landmarks = results.multiHandLandmarks[0];
                
                // ÏÜêÍ∞ÄÎùΩ ÎÅù Ï¢åÌëúÎì§
                const indexTip = landmarks[8];
                const middleTip = landmarks[12];
                const indexPip = landmarks[6];
                const middlePip = landmarks[10];
                const indexMcp = landmarks[5];
                const thumbTip = landmarks[4];
                const ringTip = landmarks[16];
                const pinkyTip = landmarks[20];
                
                // Ï∫îÎ≤ÑÏä§ Ï¢åÌëúÎ°ú Î≥ÄÌôò (Ï¢åÏö∞ Î∞òÏ†Ñ)
                const x = (1 - indexTip.x) * canvas.width;
                const y = indexTip.y * canvas.height;
                
                // ÏÜêÍ∞ÄÎùΩ Ìè¨Ïù∏ÌÑ∞ ÌëúÏãú
                fingerPoint.style.left = x + 'px';
                fingerPoint.style.top = y + 'px';
                fingerPoint.classList.remove('hidden');
                
                // ÏÜêÍ∞ÄÎùΩ ÏÉÅÌÉú ÌôïÏù∏
                const isIndexExtended = indexTip.y < indexPip.y && indexPip.y < indexMcp.y;
                const isMiddleExtended = middleTip.y < middlePip.y;
                const isThumbExtended = thumbTip.x > indexMcp.x;
                const isRingFolded = ringTip.y > landmarks[13].y;
                const isPinkyFolded = pinkyTip.y > landmarks[17].y;
                
                // Í≤ÄÏßÄÏôÄ Ï§ëÏßÄÍ∞Ä Î∂ôÏñ¥ÏûàÎäîÏßÄ ÌôïÏù∏
                const fingerDistance = Math.sqrt(
                    Math.pow((indexTip.x - middleTip.x) * canvas.width, 2) + 
                    Math.pow((indexTip.y - middleTip.y) * canvas.height, 2)
                );
                const fingersClose = fingerDistance < 30;
                
                // Ïä¨ÎùºÏù¥Îìú Ìà¥Î∞î Ï†úÏñ¥ (Ïò§Î•∏Ï™Ω Í∞ÄÏû•ÏûêÎ¶¨ 50px)
                if (x > canvas.width - 50) {
                    slideToolbar.classList.add('active');
                } else if (x < canvas.width - 200) {
                    slideToolbar.classList.remove('active');
                }
                
                // Ï†úÏä§Ï≤ò Ïù∏Ïãù
                if (isIndexExtended && isMiddleExtended && fingersClose && isRingFolded && isPinkyFolded) {
                    // Í≤ÄÏßÄ+Ï§ëÏßÄ Î∂ôÏó¨ÏÑú Ìé¥Í∏∞ = ÌÅ¥Î¶≠ Î™®Îìú
                    gestureIndicator.textContent = 'ÌÅ¥Î¶≠ Î™®Îìú üëÜ';
                    gestureIndicator.style.background = 'rgba(239, 68, 68, 0.8)';
                    fingerPoint.className = 'finger-point clicking';
                    
                    stopDrawing();
                    checkButtonClick(x, y);
                    checkToolbarClick(x, y);
                    
                } else if (isIndexExtended && !isMiddleExtended && isRingFolded && isPinkyFolded) {
                    // Í≤ÄÏßÄÎßå Ìé¥Í∏∞ = Í∑∏Î¶¨Í∏∞ Î™®Îìú
                    gestureIndicator.textContent = 'Í∑∏Î¶¨Í∏∞ Î™®Îìú ‚úèÔ∏è';
                    gestureIndicator.style.background = 'rgba(34, 197, 94, 0.8)';
                    fingerPoint.className = 'finger-point drawing';
                    
                    if (isInDrawingArea(x, y)) {
                        addDrawingPoint(x, y);
                    }
                } else {
                    // Í∏∞ÌÉÄ = Ï†ïÏßÄ Î™®Îìú
                    gestureIndicator.textContent = 'Ï†ïÏßÄ Î™®Îìú ‚úã';
                    gestureIndicator.style.background = 'rgba(59, 130, 246, 0.8)';
                    fingerPoint.className = 'finger-point';
                    stopDrawing();
                }
                
            } else {
                fingerPoint.classList.add('hidden');
                gestureIndicator.textContent = 'ÏÜêÏùÑ Ïπ¥Î©îÎùºÏóê Î≥¥Ïó¨Ï£ºÏÑ∏Ïöî';
                gestureIndicator.style.background = 'rgba(0, 0, 0, 0.7)';
                slideToolbar.classList.remove('active');
                stopDrawing();
            }
        }

        // Í∑∏Î¶¨Í∏∞ ÏòÅÏó≠ ÌôïÏù∏
        function isInDrawingArea(x, y) {
            const margin = 50;
            return x > margin && x < canvas.width - 250 && // Ïò§Î•∏Ï™Ω Ìà¥Î∞î ÏòÅÏó≠ Ï†úÏô∏
                   y > margin && y < canvas.height - 150;
        }

        // Î≤ÑÌäº ÌÅ¥Î¶≠ ÌôïÏù∏
        function checkButtonClick(x, y) {
            const currentTime = Date.now();
            if (currentTime - lastClickTime < 500) return;
            
            const clearBtnArea = { x: 50, y: canvas.height - 100, width: 180, height: 60 };
            const completeBtnArea = { x: canvas.width - 230, y: canvas.height - 100, width: 180, height: 60 };
            
            if (isPointInArea(x, y, clearBtnArea)) {
                lastClickTime = currentTime;
                document.getElementById('clearBtnPopup').classList.add('active');
                setTimeout(() => {
                    document.getElementById('clearBtnPopup').classList.remove('active');
                    clearDrawing();
                }, 200);
            } else if (isPointInArea(x, y, completeBtnArea)) {
                lastClickTime = currentTime;
                document.getElementById('completeBtnPopup').classList.add('active');
                setTimeout(() => {
                    document.getElementById('completeBtnPopup').classList.remove('active');
                    completeDrawing();
                }, 200);
            }
        }

        // Ìà¥Î∞î ÌÅ¥Î¶≠ ÌôïÏù∏
        function checkToolbarClick(x, y) {
            if (!slideToolbar.classList.contains('active')) return;
            
            const currentTime = Date.now();
            if (currentTime - lastClickTime < 300) return;
            
            // Ìéú ÌÅ¨Í∏∞ ÏÑ†ÌÉù
            document.querySelectorAll('.pen-size-option').forEach(option => {
                const rect = option.getBoundingClientRect();
                const canvasRect = canvas.getBoundingClientRect();
                const optionX = rect.left - canvasRect.left;
                const optionY = rect.top - canvasRect.top;
                const optionArea = {
                    x: optionX, y: optionY,
                    width: rect.width, height: rect.height
                };
                
                if (isPointInArea(x, y, optionArea)) {
                    lastClickTime = currentTime;
                    document.querySelectorAll('.pen-size-option').forEach(o => o.classList.remove('active'));
                    option.classList.add('active');
                    currentPenSize = parseInt(option.dataset.size);
                }
            });
            
            // Ìéú ÏÉâÏÉÅ ÏÑ†ÌÉù
            document.querySelectorAll('.color-option').forEach(option => {
                const rect = option.getBoundingClientRect();
                const canvasRect = canvas.getBoundingClientRect();
                const optionX = rect.left - canvasRect.left;
                const optionY = rect.top - canvasRect.top;
                const optionArea = {
                    x: optionX, y: optionY,
                    width: rect.width, height: rect.height
                };
                
                if (isPointInArea(x, y, optionArea)) {
                    lastClickTime = currentTime;
                    document.querySelectorAll('.color-option').forEach(o => o.classList.remove('active'));
                    option.classList.add('active');
                    currentPenColor = option.dataset.color;
                }
            });
        }

        // Ìè¨Ïù∏Ìä∏Í∞Ä ÏòÅÏó≠ ÏïàÏóê ÏûàÎäîÏßÄ ÌôïÏù∏
        function isPointInArea(x, y, area) {
            return x >= area.x && x <= area.x + area.width && 
                   y >= area.y && y <= area.y + area.height;
        }

        // Í∑∏Î¶¨Í∏∞ Ìè¨Ïù∏Ìä∏ Ï∂îÍ∞Ä
        function addDrawingPoint(x, y) {
            if (lastPoint) {
                const distance = Math.sqrt(
                    Math.pow(x - lastPoint.x, 2) + Math.pow(y - lastPoint.y, 2)
                );
                
                if (distance > 5) {
                    ctx.strokeStyle = currentPenColor;
                    ctx.lineWidth = currentPenSize;
                    ctx.lineCap = 'round';
                    ctx.lineJoin = 'round';
                    ctx.beginPath();
                    ctx.moveTo(lastPoint.x, lastPoint.y);
                    ctx.lineTo(x, y);
                    ctx.stroke();
                    
                    // ÏãúÍ∞ÅÏ†Å Ìö®Í≥º Ï∂îÍ∞Ä
                    const trail = document.createElement('div');
                    trail.className = 'drawing-trail';
                    trail.style.left = (x - 6) + 'px';
                    trail.style.top = (y - 6) + 'px';
                    trail.style.background = `radial-gradient(circle, ${currentPenColor} 0%, ${currentPenColor}80 100%)`;
                    canvas.parentElement.appendChild(trail);
                    
                    setTimeout(() => trail.remove(), 1500);
                }
            }
            
            drawingPoints.push({ x, y, timestamp: Date.now() });
            lastPoint = { x, y };
        }

        // Í∑∏Î¶¨Í∏∞ Ï§ëÏßÄ
        function stopDrawing() {
            lastPoint = null;
        }

        // ÌåùÏóÖ Ïó¥Í∏∞
        async function openDrawingPopup() {
            document.getElementById('drawingPopup').classList.remove('hidden');
            isPopupOpen = true;
            
            await initCamera();
            await initMediaPipe();
            
            clearDrawing();
        }

        // ÌåùÏóÖ Îã´Í∏∞
        function closeDrawingPopup() {
            document.getElementById('drawingPopup').classList.add('hidden');
            isPopupOpen = false;
            
            if (video && video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
                video.srcObject = null;
            }
            
            slideToolbar.classList.remove('active');
        }

        // Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà ÏÑ§Ï†ï
        function setupEventListeners() {
            document.getElementById('studentForm').addEventListener('submit', startLearning);
            document.getElementById('openDrawingBtn').addEventListener('click', openDrawingPopup);
            document.getElementById('clearBtnPopup').addEventListener('click', clearDrawing);
            document.getElementById('completeBtnPopup').addEventListener('click', completeDrawing);
            document.getElementById('nextBtn').addEventListener('click', nextQuestion);
            document.getElementById('endLearningBtn').addEventListener('click', endLearning);
            document.getElementById('sendResultBtn').addEventListener('click', sendResult);
            document.getElementById('closeModalBtn').addEventListener('click', closeModal);
            
            // ÌåùÏóÖ Ïô∏Î∂Ä ÌÅ¥Î¶≠ Ïãú Îã´Í∏∞
            document.getElementById('drawingPopup').addEventListener('click', (e) => {
                if (e.target.id === 'drawingPopup') {
                    closeDrawingPopup();
                }
            });
            
            // ESC ÌÇ§Î°ú ÌåùÏóÖ Îã´Í∏∞
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && isPopupOpen) {
                    closeDrawingPopup();
                }
            });
            
            // Ìéú ÌÅ¨Í∏∞ ÏÑ†ÌÉù Ïù¥Î≤§Ìä∏
            document.querySelectorAll('.pen-size-option').forEach(option => {
                option.addEventListener('click', () => {
                    document.querySelectorAll('.pen-size-option').forEach(o => o.classList.remove('active'));
                    option.classList.add('active');
                    currentPenSize = parseInt(option.dataset.size);
                });
            });
            
            // Ìéú ÏÉâÏÉÅ ÏÑ†ÌÉù Ïù¥Î≤§Ìä∏
            document.querySelectorAll('.color-option').forEach(option => {
                option.addEventListener('click', () => {
                    document.querySelectorAll('.color-option').forEach(o => o.classList.remove('active'));
                    option.classList.add('active');
                    currentPenColor = option.dataset.color;
                });
            });
        }

        // ÌïôÏäµ ÏãúÏûë
        function startLearning(e) {
            e.preventDefault();
            
            studentData = {
                name: document.getElementById('studentName').value,
                grade: document.getElementById('studentGrade').value,
                class: document.getElementById('studentClass').value,
                number: document.getElementById('studentNumber').value,
                email: document.getElementById('studentEmail').value
            };
            
            document.getElementById('studentInfoScreen').classList.add('hidden');
            document.getElementById('learningScreen').classList.remove('hidden');
            
            document.getElementById('studentInfo').textContent = 
                `${studentData.grade}ÌïôÎÖÑ ${studentData.class}Î∞ò ${studentData.number}Î≤à ${studentData.name}`;
            
            loadQuestion();
        }

        // Î¨∏Ï†ú Î°úÎìú
        function loadQuestion() {
            if (currentQuestionIndex >= answerData.filename.length) {
                endLearning();
                return;
            }
            
            document.getElementById('characterMeaning').textContent = answerData.meaning[currentQuestionIndex];
            document.getElementById('characterSound').textContent = answerData.sound[currentQuestionIndex];
            document.getElementById('answerImage').src = `images/${answerData.filename[currentQuestionIndex]}`;
            document.getElementById('currentQuestion').textContent = currentQuestionIndex + 1;
            
            document.getElementById('nextBtn').disabled = true;
            document.getElementById('resultPanel').innerHTML = '<div class="text-center text-gray-500 p-8 bg-gray-50 rounded-2xl">ÌóàÍ≥µÏóê ÌïúÏûêÎ•º Ïç®Ï£ºÏÑ∏Ïöî</div>';
        }

        // Í∑∏Î¶¨Í∏∞ ÏßÄÏö∞Í∏∞
        function clearDrawing() {
            if (ctx) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            }
            drawingPoints = [];
            lastPoint = null;
        }

        // Í∑∏Î¶¨Í∏∞ ÏôÑÎ£å
        function completeDrawing() {
            if (drawingPoints.length === 0) {
                alert('ÌïúÏûêÎ•º Ïç®Ï£ºÏÑ∏Ïöî!');
                return;
            }
            
            const score = evaluateDrawing();
            scores.push(score);
            totalScore += score;
            
            document.getElementById('currentScore').textContent = totalScore;
            
            const resultPanel = document.getElementById('resultPanel');
            const isCorrect = score > 5;
            
            resultPanel.innerHTML = `
                <div class="text-center p-6 rounded-2xl ${isCorrect ? 'bg-green-50' : 'bg-red-50'}">
                    <div class="text-6xl mb-4">${isCorrect ? 'üéâ' : 'üòî'}</div>
                    <div class="text-2xl font-bold ${isCorrect ? 'text-green-600' : 'text-red-600'} mb-2">
                        ${isCorrect ? 'Ï†ïÎãµ!' : 'Ïò§Îãµ'}
                    </div>
                    <div class="text-xl text-gray-600">Ï†êÏàò: ${score}/10</div>
                </div>
            `;
            
            document.getElementById('nextBtn').disabled = false;
            saveToCsv(score);
            closeDrawingPopup();
        }

        // Í∞ÑÎã®Ìïú Ï±ÑÏ†ê Ìï®Ïàò
        function evaluateDrawing() {
            const strokeCount = Math.floor(drawingPoints.length / 15);
            const complexity = calculateComplexity();
            const baseScore = Math.min(strokeCount, 7);
            const complexityBonus = Math.min(complexity, 3);
            return Math.min(baseScore + complexityBonus, 10);
        }

        // Î≥µÏû°ÎèÑ Í≥ÑÏÇ∞
        function calculateComplexity() {
            if (drawingPoints.length < 10) return 0;
            
            let directionChanges = 0;
            for (let i = 2; i < drawingPoints.length; i++) {
                const prev = drawingPoints[i-2];
                const curr = drawingPoints[i-1];
                const next = drawingPoints[i];
                
                const angle1 = Math.atan2(curr.y - prev.y, curr.x - prev.x);
                const angle2 = Math.atan2(next.y - curr.y, next.x - curr.x);
                const angleDiff = Math.abs(angle2 - angle1);
                
                if (angleDiff > Math.PI / 4) {
                    directionChanges++;
                }
            }
            
            return Math.min(Math.floor(directionChanges / 3), 3);
        }

        // CSV Ï†ÄÏû•
        function saveToCsv(score) {
            const csvData = `${studentData.name},${studentData.grade},${studentData.class},${studentData.number},${studentData.email},${currentQuestionIndex + 1},${score},${new Date().toISOString()}\n`;
            localStorage.setItem('myscore_' + Date.now(), csvData);
        }

        // Îã§Ïùå Î¨∏Ï†ú
        function nextQuestion() {
            currentQuestionIndex++;
            loadQuestion();
        }

        // ÌïôÏäµ Ï¢ÖÎ£å
        function endLearning() {
            const accuracy = Math.round((scores.filter(s => s > 5).length / Math.max(scores.length, 1)) * 100);
            
            document.getElementById('finalScore').textContent = totalScore;
            document.getElementById('accuracy').textContent = accuracy;
            document.getElementById('resultEmail').value = studentData.email;
            document.getElementById('endModal').classList.remove('hidden');
        }

        // Í≤∞Í≥º Ï†ÑÏÜ°
        function sendResult() {
            const email = document.getElementById('resultEmail').value;
            if (!email) {
                alert('Ïù¥Î©îÏùºÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî!');
                return;
            }
            
            const resultData = {
                student: studentData,
                totalScore: totalScore,
                accuracy: Math.round((scores.filter(s => s > 5).length / Math.max(scores.length, 1)) * 100),
                scores: scores,
                timestamp: new Date().toISOString()
            };
            
            console.log('Í≤∞Í≥º Ï†ÑÏÜ°:', resultData);
            alert(`ÌïôÏäµ Í≤∞Í≥ºÍ∞Ä ${email}Î°ú Ï†ÑÏÜ°ÎêòÏóàÏäµÎãàÎã§!`);
            closeModal();
        }

        // Î™®Îã¨ Îã´Í∏∞
        function closeModal() {
            document.getElementById('endModal').classList.add('hidden');
            location.reload();
        }

        // ÌéòÏù¥ÏßÄ Î°úÎìú ÏôÑÎ£å ÌõÑ Ï¥àÍ∏∞Ìôî
        window.addEventListener('load', () => {
            init().catch(console.error);
        });
    </script>
</body>
</html>